# Firestore Database Schema

## Overview

This document defines the Firestore NoSQL schema for the REGAIN application. The schema uses a **sub-collection pattern** to organize user-specific data under each user's document.

## Architecture Principles

1. **User-centric structure**: All user data is stored under `users/{uid}/`
2. **Sub-collections**: Use sub-collections for related data (workouts, sessions, etc.)
3. **Denormalization**: Store frequently accessed data together (e.g., sessions within training systems)
4. **Timestamps**: Use Firestore Timestamps for all date fields
5. **Indexes**: Will be created automatically by Firestore for common queries

---

## Collections Structure

```
users/
  {uid}/
    ├── (document fields: profile data)
    ├── trainingSystems/
    │   └── {systemId}/
    │       └── sessions/
    │           └── {sessionId}
    ├── completedSessions/
    │   └── {completedSessionId}
    └── milestones/
        └── {milestoneId}
```

---

## Collection: `users`

**Path**: `users/{uid}`

**Description**: Root document for each user. Stores basic profile information and preferences.

### Document Fields

```typescript
{
  // Basic Info
  email: string
  displayName?: string
  role: 'athlete' | 'coach'
  photoURL?: string
  
  // Profile Data (from onboarding)
  preferredDisciplines: string[]  // e.g., ['Pilates', 'Animal Flow']
  discomforts: string[]          // e.g., ['lower back', 'knees']
  equipment: string[]             // e.g., ['dumbbells', 'resistance bands']
  goals: string[]
  objectives?: string[]           // Training objectives from final onboarding question (baseline assessment Q18)
  sedentaryImpact?: string        // From onboarding question 1
  
  // Baseline Assessment (from Phase 2 onboarding)
  baselineAssessment?: {
    mobility: {
      overheadReach: number      // 1-5
      shoulderRotation: number   // 1-5
      hipFlexibility: number     // 1-5
      overallScore: number       // Calculated average (1-5)
    }
    rotation: {
      spinalRotation: number     // 1-5
      dailyRotationFrequency: number  // 1-4 (Rarely → Very Often)
      overallScore: number       // Calculated (1-5 equivalent)
    }
    flexibility: {
      lowerBody: number          // 1-5
      upperBody: number          // 1-5
      overallScore: number       // Calculated average (1-5)
    }
    physiological?: {
      age?: number
      activityLevel?: 'sedentary' | 'lightly-active' | 'moderately-active' | 'very-active' | 'extremely-active'
      height?: number            // cm
      weight?: number            // kg
      bodyFatPercent?: number    // 0-100
      injuryHistory?: string     // Free text
    }
    baselineMetrics: {
      mobility: number           // 0-100 (converted from overallScore)
      rotation: number           // 0-100 (converted from overallScore)
      flexibility: number        // 0-100 (converted from overallScore)
    }
    completedAt: Timestamp
    version: string              // "1.0"
  }
  
  // Activity Tracking
  currentStreak?: number        // Current consecutive training day streak
  longestStreak?: number        // Personal best streak (highest streak ever achieved)
  totalSessions?: number         // Total completed sessions count
  lastSessionDate?: string       // ISO date string of last completed session
  
  // Metadata
  createdAt: Timestamp
  updatedAt: Timestamp
  lastLoginAt?: Timestamp
}
```

### Example

```json
{
  "email": "athlete@example.com",
  "displayName": "John Doe",
  "role": "athlete",
  "preferredDisciplines": ["Pilates", "Animal Flow"],
  "discomforts": ["lower back"],
  "equipment": [],
  "goals": ["strength", "flexibility"],
  "baselineAssessment": {
    "mobility": {
      "overheadReach": 4,
      "shoulderRotation": 3,
      "hipFlexibility": 3,
      "overallScore": 3.3
    },
    "rotation": {
      "spinalRotation": 3,
      "dailyRotationFrequency": 2,
      "overallScore": 3.2
    },
    "flexibility": {
      "lowerBody": 3,
      "upperBody": 4,
      "overallScore": 3.5
    },
    "physiological": {
      "age": 30,
      "activityLevel": "moderately-active",
      "height": 175,
      "weight": 75
    },
    "baselineMetrics": {
      "mobility": 66,
      "rotation": 64,
      "flexibility": 70
    },
    "completedAt": "2025-01-15T10:30:00Z",
    "version": "1.0"
  },
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

---

## Sub-Collection: `users/{uid}/trainingSystems`

**Path**: `users/{uid}/trainingSystems/{systemId}`

**Description**: Stores weekly training systems generated for the user. **Sessions belong to the training system and are stored as a sub-collection.**

### Document Fields

```typescript
{
  id: string                    // Auto-generated by Firestore
  type: 'weekly'                // Type of training system
  startDate: Timestamp          // When the system starts
  daysPerWeek: number           // e.g., 3, 4, 5
  framework: string             // e.g., 'Push/Pull', 'Upper/Lower'
  editable: boolean
  createdAt: Timestamp
  updatedAt: Timestamp
}
```

**Note**: Sessions are **NOT** stored in the system document. They are stored in the `sessions` sub-collection below.

---

## Sub-Collection: `users/{uid}/trainingSystems/{systemId}/sessions`

**Path**: `users/{uid}/trainingSystems/{systemId}/sessions/{sessionId}`

**Description**: Stores individual sessions that belong to a training system. The AI generates these sessions when the user clicks "Generate". Each session is a document in this sub-collection.

### Document Fields

```typescript
{
  id: string                    // Auto-generated by Firestore
  day: number                   // 1-indexed day number (1, 2, 3, etc.)
  date: string                  // ISO date string (YYYY-MM-DD)
  discipline: string            // e.g., 'Pilates'
  workout: string               // e.g., 'Push', 'Pull', 'Legs'
  phases: {
    warmup: Variation[]
    workout: Variation[]
    cooldown: Variation[]
  }
  editable: boolean
  completed?: boolean
  completedAt?: Timestamp
  createdAt: Timestamp
  updatedAt: Timestamp
}
```

### Variation Object (within session.phases)

```typescript
{
  exerciseId: string
  exerciseName: string
  variationId: string
  variationName: string
  difficulty_score: number
  weight: number
  bilaterality: 'bilateral' | 'unilateral'
  progression_type: string
  target_muscles: {
    primary: string[]
    secondary: string[]
  }
  technique_cues: string[]
  sets?: number                 // Filled during session
  reps?: number                 // Filled during session
}
```

### Example: Training System Document

```json
{
  "id": "weekly-system-1704067200000",
  "type": "weekly",
  "startDate": "2025-01-01T00:00:00Z",
  "daysPerWeek": 3,
  "framework": "Push/Pull",
  "editable": true,
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-01-01T00:00:00Z"
}
```

### Example: Session Document (in `trainingSystems/{systemId}/sessions/{sessionId}`)

```json
{
  "id": "session-abc123",
  "day": 1,
  "date": "2025-01-01",
  "discipline": "Pilates",
  "workout": "Push",
  "phases": {
    "warmup": [
      {
        "exerciseId": "pilates-hundred",
        "exerciseName": "The Hundred",
        "variationId": "hundred-modified",
        "variationName": "Modified Hundred (Knees Bent)",
        "difficulty_score": 3,
        "weight": 0,
        "bilaterality": "bilateral",
        "progression_type": "stability",
        "target_muscles": {
          "primary": ["abs", "core"],
          "secondary": ["shoulders", "hip flexors"]
        },
        "technique_cues": ["Maintain neutral spine..."]
      }
    ],
    "workout": [],
    "cooldown": []
  },
  "editable": true,
  "completed": false,
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-01-01T00:00:00Z"
}
```

---

## Sub-Collection: `users/{uid}/milestones`

**Path**: `users/{uid}/milestones/{milestoneId}`

**Description**: Tracks progressive overload milestones for exercises. Stores exercise progress separately for easier querying and updates.

### Document Fields

```typescript
{
  id: string                    // Auto-generated
  exerciseId: string            // e.g., 'pilates-hundred'
  variationId: string           // e.g., 'hundred-modified'
  sessionCount: number          // Number of sessions completed (0-3)
  lastCompletedAt?: Timestamp   // Last time this variation was completed
  createdAt: Timestamp
  updatedAt: Timestamp
}
```

### Alternative Structure (Nested Object)

**Note**: For simplicity, milestones can also be stored as a nested object in the user profile:

```typescript
// In users/{uid} document:
{
  currentMilestones: {
    [exerciseId]: {
      [variationId]: number  // sessionCount
    }
  }
}
```

**Recommendation**: Use nested object for MVP, migrate to sub-collection if querying becomes complex.

### Example (Nested Object)

```json
{
  "currentMilestones": {
    "pilates-hundred": {
      "hundred-modified": 2,
      "hundred-standard": 0
    },
    "pilates-roll-up": {
      "roll-up-assisted": 3
    }
  }
}
```

---

## Sub-Collection: `users/{uid}/workouts` (Future)

**Path**: `users/{uid}/workouts/{workoutId}`

**Description**: For future expansion - individual workout plans separate from training systems.

### Document Fields

```typescript
{
  id: string
  name: string
  discipline: string
  framework: string
  createdAt: Timestamp
  updatedAt: Timestamp
}
```

---

## Sub-Collection: `users/{uid}/completedSessions`

**Path**: `users/{uid}/completedSessions/{completedSessionId}`

**Description**: Stores completed session performance data. Links back to the original session via `systemId` and `sessionId` references.

### Document Fields

```typescript
{
  id: string                    // Auto-generated
  systemId: string              // Reference to training system
  sessionId: string             // Reference to original session in training system
  date: string                  // ISO date string (YYYY-MM-DD)
  startedAt: Timestamp          // When session started
  completedAt: Timestamp        // When session completed
  duration: number              // Total duration in seconds
  warmup: Phase                 // Actual performance data
  workout: Phase                // Actual performance data
  cooldown: Phase               // Actual performance data
  metricsSummary: {
    mobility: number            // 0-100
    rotation: number            // 0-100
    flexibility: number         // 0-100
  }
  createdAt: Timestamp
  updatedAt: Timestamp
}
```

**Note**: This is separate from the planned sessions in the training system. When a user completes a session, the performance data is stored here.

---

## Indexes Required

Firestore will automatically create indexes for:
- `users/{uid}/trainingSystems` ordered by `createdAt desc`
- `users/{uid}/trainingSystems` filtered by `type`

**Manual indexes** (create in Firebase Console if needed):
- Composite queries on training systems (e.g., type + startDate)

---

## Data Migration Notes

### From localStorage to Firestore

1. **User Profile**: 
   - `localStorage.userProfile` → `users/{uid}` document
   - `localStorage.onboardingData` → merged into `users/{uid}` document

2. **Training System**:
   - `localStorage.trainingSystem` → `users/{uid}/trainingSystems/{systemId}`

3. **Milestones**:
   - `userProfile.currentMilestones` → `users/{uid}.currentMilestones` (nested object)

4. **Session Progress**:
   - `localStorage.sessionProgress` → Can be stored in session object or separate sub-collection

---

## Security Rules ✅ IMPLEMENTED

**Status**: Security rules are implemented and ready for deployment.

**File**: `firestore.rules` (project root)

The Firestore security rules enforce:
- ✅ Users can only read/write their own data (`users/{userId}`)
- ✅ Authentication is required for all operations
- ✅ Sub-collections are protected (trainingSystems, milestones, workouts, sessions)
- ✅ Collection-level queries are denied (prevents listing all users)
- ✅ Field validation on user profile writes (email, role)
- ✅ Default deny-all for any undefined collections

**Deployment**:

1. **Update project ID**: Edit `.firebaserc` with your Firebase project ID
2. **Install Firebase CLI**: `npm install` (firebase-tools added to devDependencies)
3. **Login**: `firebase login`
4. **Deploy rules**: `npm run firebase:deploy-rules`

**Note**: Rules must be deployed to Firebase before they take effect. The rules file exists locally but is not active until deployed.

**Testing**: Use Firebase Emulator Suite to test rules locally:
```bash
npm run firebase:test-rules
```

See `firestore.rules` for the complete implementation with helper functions and comprehensive validation.

---

## Query Patterns

### Get user's latest training system
```javascript
const systemsRef = collection(db, 'users', userId, 'trainingSystems');
const q = query(systemsRef, orderBy('createdAt', 'desc'), limit(1));
```

### Get all training systems for a user
```javascript
const systemsRef = collection(db, 'users', userId, 'trainingSystems');
const q = query(systemsRef, orderBy('createdAt', 'desc'));
```

### Get training system by ID
```javascript
const systemRef = doc(db, 'users', userId, 'trainingSystems', systemId);
```

---

## Notes

- **Exercises data** (`exercises.json`) remains static and can be:
  1. Stored in Firestore as a public collection (for versioning)
  2. Kept as static JSON file (current approach)
  3. Moved to Cloud Storage

- **Coach functionality**: Future expansion will add:
  - `coaches/{coachId}/clients/{clientId}` relationships
  - Shared training systems between coach and athlete

