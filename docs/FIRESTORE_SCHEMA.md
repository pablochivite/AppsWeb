# Firestore Database Schema

## Overview

This document defines the Firestore NoSQL schema for the REGAIN application. The schema uses a **sub-collection pattern** to organize user-specific data under each user's document.

## Architecture Principles

1. **User-centric structure**: All user data is stored under `users/{uid}/`
2. **Sub-collections**: Use sub-collections for related data (workouts, sessions, etc.)
3. **Denormalization**: Store frequently accessed data together (e.g., sessions within training systems)
4. **Timestamps**: Use Firestore Timestamps for all date fields
5. **Indexes**: Will be created automatically by Firestore for common queries

---

## Collections Structure

```
users/
  {uid}/
    ├── (document fields: profile data)
    ├── workouts/
    │   └── {workoutId}/
    │       └── sessions/
    │           └── {sessionId}
    ├── trainingSystems/
    │   └── {systemId}
    └── milestones/
        └── {milestoneId}
```

---

## Collection: `users`

**Path**: `users/{uid}`

**Description**: Root document for each user. Stores basic profile information and preferences.

### Document Fields

```typescript
{
  // Basic Info
  email: string
  displayName?: string
  role: 'athlete' | 'coach'
  photoURL?: string
  
  // Profile Data (from onboarding)
  preferredDisciplines: string[]  // e.g., ['Pilates', 'Animal Flow']
  discomforts: string[]          // e.g., ['lower back', 'knees']
  equipment: string[]             // e.g., ['dumbbells', 'resistance bands']
  goals: string[]
  sedentaryImpact?: string        // From onboarding question 1
  
  // Metadata
  createdAt: Timestamp
  updatedAt: Timestamp
  lastLoginAt?: Timestamp
}
```

### Example

```json
{
  "email": "athlete@example.com",
  "displayName": "John Doe",
  "role": "athlete",
  "preferredDisciplines": ["Pilates", "Animal Flow"],
  "discomforts": ["lower back"],
  "equipment": [],
  "goals": ["strength", "flexibility"],
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-01-15T10:30:00Z"
}
```

---

## Sub-Collection: `users/{uid}/trainingSystems`

**Path**: `users/{uid}/trainingSystems/{systemId}`

**Description**: Stores weekly training systems generated for the user.

### Document Fields

```typescript
{
  id: string                    // Auto-generated by Firestore
  type: 'weekly'                // Type of training system
  startDate: Timestamp          // When the system starts
  daysPerWeek: number           // e.g., 3, 4, 5
  framework: string             // e.g., 'Push/Pull', 'Upper/Lower'
  sessions: Session[]           // Array of session objects (denormalized)
  editable: boolean
  createdAt: Timestamp
  updatedAt: Timestamp
}
```

### Session Object (within trainingSystem.sessions array)

```typescript
{
  id?: string                   // Optional session ID
  day: number                   // 1-indexed day number
  date: string                  // ISO date string (YYYY-MM-DD)
  discipline: string            // e.g., 'Pilates'
  workout: string               // e.g., 'Push', 'Pull', 'Legs'
  phases: {
    warmup: Variation[]
    workout: Variation[]
    cooldown: Variation[]
  }
  editable: boolean
  completed?: boolean
  completedAt?: Timestamp
}
```

### Variation Object (within session.phases)

```typescript
{
  exerciseId: string
  exerciseName: string
  variationId: string
  variationName: string
  difficulty_score: number
  weight: number
  bilaterality: 'bilateral' | 'unilateral'
  progression_type: string
  target_muscles: {
    primary: string[]
    secondary: string[]
  }
  technique_cues: string[]
  sets?: number                 // Filled during session
  reps?: number                 // Filled during session
}
```

### Example

```json
{
  "id": "weekly-system-1704067200000",
  "type": "weekly",
  "startDate": "2025-01-01T00:00:00Z",
  "daysPerWeek": 3,
  "framework": "Push/Pull",
  "sessions": [
    {
      "day": 1,
      "date": "2025-01-01",
      "discipline": "Pilates",
      "workout": "Push",
      "phases": {
        "warmup": [
          {
            "exerciseId": "pilates-hundred",
            "exerciseName": "The Hundred",
            "variationId": "hundred-modified",
            "variationName": "Modified Hundred (Knees Bent)",
            "difficulty_score": 3,
            "weight": 0,
            "bilaterality": "bilateral",
            "progression_type": "stability",
            "target_muscles": {
              "primary": ["abs", "core"],
              "secondary": ["shoulders", "hip flexors"]
            },
            "technique_cues": ["Maintain neutral spine..."]
          }
        ],
        "workout": [],
        "cooldown": []
      },
      "editable": true
    }
  ],
  "editable": true,
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-01-01T00:00:00Z"
}
```

---

## Sub-Collection: `users/{uid}/milestones`

**Path**: `users/{uid}/milestones/{milestoneId}`

**Description**: Tracks progressive overload milestones for exercises. Stores exercise progress separately for easier querying and updates.

### Document Fields

```typescript
{
  id: string                    // Auto-generated
  exerciseId: string            // e.g., 'pilates-hundred'
  variationId: string           // e.g., 'hundred-modified'
  sessionCount: number          // Number of sessions completed (0-3)
  lastCompletedAt?: Timestamp   // Last time this variation was completed
  createdAt: Timestamp
  updatedAt: Timestamp
}
```

### Alternative Structure (Nested Object)

**Note**: For simplicity, milestones can also be stored as a nested object in the user profile:

```typescript
// In users/{uid} document:
{
  currentMilestones: {
    [exerciseId]: {
      [variationId]: number  // sessionCount
    }
  }
}
```

**Recommendation**: Use nested object for MVP, migrate to sub-collection if querying becomes complex.

### Example (Nested Object)

```json
{
  "currentMilestones": {
    "pilates-hundred": {
      "hundred-modified": 2,
      "hundred-standard": 0
    },
    "pilates-roll-up": {
      "roll-up-assisted": 3
    }
  }
}
```

---

## Sub-Collection: `users/{uid}/workouts` (Future)

**Path**: `users/{uid}/workouts/{workoutId}`

**Description**: For future expansion - individual workout plans separate from training systems.

### Document Fields

```typescript
{
  id: string
  name: string
  discipline: string
  framework: string
  createdAt: Timestamp
  updatedAt: Timestamp
}
```

---

## Sub-Collection: `users/{uid}/sessions` (Future)

**Path**: `users/{uid}/workouts/{workoutId}/sessions/{sessionId}`

**Description**: For future expansion - individual session records with completion data.

### Document Fields

```typescript
{
  id: string
  workoutId: string
  date: Timestamp
  completed: boolean
  completedAt?: Timestamp
  exercises: {
    exerciseId: string
    variationId: string
    sets: number
    reps: number
    notes?: string
  }[]
  createdAt: Timestamp
  updatedAt: Timestamp
}
```

---

## Indexes Required

Firestore will automatically create indexes for:
- `users/{uid}/trainingSystems` ordered by `createdAt desc`
- `users/{uid}/trainingSystems` filtered by `type`

**Manual indexes** (create in Firebase Console if needed):
- Composite queries on training systems (e.g., type + startDate)

---

## Data Migration Notes

### From localStorage to Firestore

1. **User Profile**: 
   - `localStorage.userProfile` → `users/{uid}` document
   - `localStorage.onboardingData` → merged into `users/{uid}` document

2. **Training System**:
   - `localStorage.trainingSystem` → `users/{uid}/trainingSystems/{systemId}`

3. **Milestones**:
   - `userProfile.currentMilestones` → `users/{uid}.currentMilestones` (nested object)

4. **Session Progress**:
   - `localStorage.sessionProgress` → Can be stored in session object or separate sub-collection

---

## Security Rules (Future)

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read/write their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /trainingSystems/{systemId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      match /milestones/{milestoneId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
```

---

## Query Patterns

### Get user's latest training system
```javascript
const systemsRef = collection(db, 'users', userId, 'trainingSystems');
const q = query(systemsRef, orderBy('createdAt', 'desc'), limit(1));
```

### Get all training systems for a user
```javascript
const systemsRef = collection(db, 'users', userId, 'trainingSystems');
const q = query(systemsRef, orderBy('createdAt', 'desc'));
```

### Get training system by ID
```javascript
const systemRef = doc(db, 'users', userId, 'trainingSystems', systemId);
```

---

## Notes

- **Exercises data** (`exercises.json`) remains static and can be:
  1. Stored in Firestore as a public collection (for versioning)
  2. Kept as static JSON file (current approach)
  3. Moved to Cloud Storage

- **Coach functionality**: Future expansion will add:
  - `coaches/{coachId}/clients/{clientId}` relationships
  - Shared training systems between coach and athlete

